<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZTunnel Inspector</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#c9d1d9;--text2:#8b949e;
    --accent:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922;--purple:#bc8cff}
  body{font-family:'Inter','SF Pro',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  .header{background:linear-gradient(135deg,#0d1117 0%,#161b22 100%);border-bottom:1px solid var(--border);
    padding:16px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
  .header h1{font-size:18px;font-weight:600;display:flex;align-items:center;gap:8px}
  .header h1 span{color:var(--accent)}
  .stats{display:flex;gap:16px}
  .stat{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 16px;text-align:center}
  .stat-val{font-size:20px;font-weight:700;color:var(--accent)}
  .stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
  .controls{display:flex;gap:8px;padding:12px 24px;border-bottom:1px solid var(--border);align-items:center}
  .controls input{background:var(--surface);border:1px solid var(--border);color:var(--text);
    padding:8px 12px;border-radius:6px;font-size:13px;width:280px;outline:none}
  .controls input:focus{border-color:var(--accent)}
  .controls select{background:var(--surface);border:1px solid var(--border);color:var(--text);
    padding:8px 10px;border-radius:6px;font-size:13px;outline:none}
  .btn{padding:8px 16px;border-radius:6px;border:1px solid var(--border);background:var(--surface);
    color:var(--text);cursor:pointer;font-size:13px;font-weight:500;transition:all .15s}
  .btn:hover{border-color:var(--accent);color:var(--accent)}
  .btn-accent{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-accent:hover{opacity:.85}
  .btn-red{background:var(--red);border-color:var(--red);color:#fff}
  .btn-red:hover{opacity:.85}
  .table-wrap{padding:0 24px 24px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th{background:var(--surface);color:var(--text2);font-size:11px;text-transform:uppercase;letter-spacing:.5px;
    padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:58px}
  td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:top}
  tr{transition:background .1s}tr:hover{background:rgba(88,166,255,.05)}
  tr.expanded{background:rgba(88,166,255,.08)}
  .method{font-weight:700;font-size:12px;padding:3px 8px;border-radius:4px;display:inline-block}
  .GET{background:rgba(63,185,80,.15);color:var(--green)}
  .POST{background:rgba(88,166,255,.15);color:var(--accent)}
  .PUT{background:rgba(210,153,34,.15);color:var(--orange)}
  .DELETE{background:rgba(248,81,73,.15);color:var(--red)}
  .PATCH{background:rgba(188,140,255,.15);color:var(--purple)}
  .status{font-weight:600;font-size:13px}
  .s2xx{color:var(--green)}.s3xx{color:var(--accent)}.s4xx{color:var(--orange)}.s5xx{color:var(--red)}
  .latency{color:var(--text2);font-variant-numeric:tabular-nums}
  .path{color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;max-width:300px;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .time{color:var(--text2);font-size:12px;white-space:nowrap}
  .detail{display:none;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin:8px 0;overflow:hidden}
  .detail.show{display:block}
  .detail-tabs{display:flex;border-bottom:1px solid var(--border)}
  .detail-tab{padding:8px 16px;font-size:12px;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent}
  .detail-tab.active{color:var(--accent);border-color:var(--accent)}
  .detail-body{padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;
    white-space:pre-wrap;word-break:break-all;max-height:300px;overflow:auto;line-height:1.6}
  .detail-body::-webkit-scrollbar{width:6px}
  .detail-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  .replay-btn{font-size:11px;padding:4px 10px;cursor:pointer}
  .empty{text-align:center;padding:60px 24px;color:var(--text2)}
  .empty svg{width:48px;height:48px;opacity:.3;margin-bottom:12px}
  .live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;
    animation:pulse 2s infinite;margin-right:6px}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  .toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:#fff;padding:10px 20px;
    border-radius:8px;font-size:13px;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s}
  .toast.show{transform:translateY(0);opacity:1}
</style>
</head>
<body>
<div class="header">
  <h1>âš¡ <span>ZTunnel</span> Inspector</h1>
  <div class="stats">
    <div class="stat"><div class="stat-val" id="totalReqs">0</div><div class="stat-label">Requests</div></div>
    <div class="stat"><div class="stat-val s2xx" id="successReqs">0</div><div class="stat-label">2xx</div></div>
    <div class="stat"><div class="stat-val s4xx" id="clientErrs">0</div><div class="stat-label">4xx</div></div>
    <div class="stat"><div class="stat-val s5xx" id="serverErrs">0</div><div class="stat-label">5xx</div></div>
    <div class="stat"><div class="stat-val" id="avgLatency">0ms</div><div class="stat-label">Avg Latency</div></div>
  </div>
</div>
<div class="controls">
  <span class="live-dot"></span><span style="font-size:12px;color:var(--text2);margin-right:12px">Live</span>
  <input type="text" id="filterInput" placeholder="Filter by path, method, or status...">
  <select id="methodFilter">
    <option value="">All Methods</option>
    <option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option><option>PATCH</option>
  </select>
  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="2">2xx</option><option value="3">3xx</option><option value="4">4xx</option><option value="5">5xx</option>
  </select>
  <button class="btn btn-red" onclick="clearAll()">Clear</button>
</div>
<div class="table-wrap">
  <table>
    <thead>
      <tr><th>#</th><th>Time</th><th>Method</th><th>Path</th><th>Status</th><th>Latency</th><th>Size</th><th>Actions</th></tr>
    </thead>
    <tbody id="reqTable"></tbody>
  </table>
  <div class="empty" id="emptyState">
    <div style="font-size:32px;margin-bottom:8px">ðŸ“¡</div>
    <div>Waiting for requests...</div>
    <div style="font-size:12px;margin-top:4px">Requests will appear here in real-time</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
const entries=[];let counter=0,s2xx=0,s4xx=0,s5xx=0,totalLat=0;
const table=document.getElementById('reqTable'),
  empty=document.getElementById('emptyState'),
  toast=document.getElementById('toast');

// SSE connection
const evtSrc=new EventSource('/events');
evtSrc.onmessage=function(e){
  try{const d=JSON.parse(e.data);addEntry(d)}catch(ex){console.error(ex)}
};
evtSrc.onerror=function(){console.log('SSE reconnecting...')};

function addEntry(d){
  entries.unshift(d);counter++;
  if(d.status>=200&&d.status<300)s2xx++;
  else if(d.status>=400&&d.status<500)s4xx++;
  else if(d.status>=500)s5xx++;
  totalLat+=d.latency_ms||0;
  updateStats();renderTable()
}

function updateStats(){
  document.getElementById('totalReqs').textContent=counter;
  document.getElementById('successReqs').textContent=s2xx;
  document.getElementById('clientErrs').textContent=s4xx;
  document.getElementById('serverErrs').textContent=s5xx;
  document.getElementById('avgLatency').textContent=counter?Math.round(totalLat/counter)+'ms':'0ms'
}

function renderTable(){
  const f=document.getElementById('filterInput').value.toLowerCase();
  const mf=document.getElementById('methodFilter').value;
  const sf=document.getElementById('statusFilter').value;
  const filtered=entries.filter(d=>{
    if(mf&&d.method!==mf)return false;
    if(sf&&!String(d.status).startsWith(sf))return false;
    if(f){const txt=(d.method+' '+d.path+' '+d.status).toLowerCase();if(!txt.includes(f))return false}
    return true
  });
  empty.style.display=filtered.length?'none':'block';
  table.innerHTML=filtered.map((d,i)=>{
    const sc=d.status<300?'s2xx':d.status<400?'s3xx':d.status<500?'s4xx':'s5xx';
    const sz=d.res_body_size||0;
    const szStr=sz>1024?(sz/1024).toFixed(1)+'KB':sz+'B';
    const ts=new Date(d.timestamp).toLocaleTimeString();
    return `<tr onclick="toggle(${entries.indexOf(d)})" style="cursor:pointer" id="row-${entries.indexOf(d)}">
      <td style="color:var(--text2)">${counter-entries.indexOf(d)}</td>
      <td class="time">${ts}</td>
      <td><span class="method ${d.method}">${d.method}</span></td>
      <td class="path" title="${esc(d.path)}">${esc(d.path)}</td>
      <td><span class="status ${sc}">${d.status}</span></td>
      <td class="latency">${d.latency_ms||0}ms</td>
      <td class="latency">${szStr}</td>
      <td><button class="btn replay-btn" onclick="replay(event,${entries.indexOf(d)})">â†» Replay</button></td>
    </tr>
    <tr id="detail-${entries.indexOf(d)}" style="display:none"><td colspan="8" style="padding:0">
      <div class="detail show" style="display:block">
        <div class="detail-tabs">
          <div class="detail-tab active" onclick="showTab(${entries.indexOf(d)},'req',this)">Request</div>
          <div class="detail-tab" onclick="showTab(${entries.indexOf(d)},'res',this)">Response</div>
          <div class="detail-tab" onclick="showTab(${entries.indexOf(d)},'hdr',this)">Headers</div>
        </div>
        <div class="detail-body" id="dbody-${entries.indexOf(d)}">${fmtReq(d)}</div>
      </div>
    </td></tr>`
  }).join('')
}

function toggle(i){
  const dr=document.getElementById('detail-'+i);
  const rr=document.getElementById('row-'+i);
  if(!dr)return;
  if(dr.style.display==='none'){dr.style.display='';rr.classList.add('expanded')}
  else{dr.style.display='none';rr.classList.remove('expanded')}
}

function showTab(i,tab,el){
  el.parentElement.querySelectorAll('.detail-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const d=entries[i],body=document.getElementById('dbody-'+i);
  if(tab==='req')body.textContent=fmtReq(d);
  else if(tab==='res')body.textContent=fmtRes(d);
  else body.textContent=fmtHdr(d)
}

function fmtReq(d){
  let s=d.method+' '+d.path+'\n\n';
  if(d.req_headers)d.req_headers.forEach(h=>s+=h[0]+': '+h[1]+'\n');
  if(d.req_body)s+='\n'+tryFmt(d.req_body);
  return s
}
function fmtRes(d){
  let s='HTTP '+d.status+'\n\n';
  if(d.res_headers)d.res_headers.forEach(h=>s+=h[0]+': '+h[1]+'\n');
  if(d.res_body)s+='\n'+tryFmt(d.res_body);
  return s
}
function fmtHdr(d){
  let s='â”€â”€ Request Headers â”€â”€\n';
  if(d.req_headers)d.req_headers.forEach(h=>s+=h[0]+': '+h[1]+'\n');
  s+='\nâ”€â”€ Response Headers â”€â”€\n';
  if(d.res_headers)d.res_headers.forEach(h=>s+=h[0]+': '+h[1]+'\n');
  return s
}
function tryFmt(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch(e){return s}}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

async function replay(ev,i){
  ev.stopPropagation();
  try{
    const r=await fetch('/replay/'+entries[i].id,{method:'POST'});
    if(r.ok)showToast('âœ“ Replayed successfully');else showToast('âœ— Replay failed: '+r.statusText)
  }catch(e){showToast('âœ— '+e.message)}
}

function clearAll(){entries.length=0;counter=0;s2xx=0;s4xx=0;s5xx=0;totalLat=0;updateStats();renderTable()}

function showToast(msg){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2500)}

document.getElementById('filterInput').addEventListener('input',renderTable);
document.getElementById('methodFilter').addEventListener('change',renderTable);
document.getElementById('statusFilter').addEventListener('change',renderTable);
</script>
</body>
</html>
